<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKT Success Dashboard</title>
    <!-- Tailwind CSS CDN für schnelle und responsive Stile -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome für Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Definieren der benutzerdefinierten Farben von SKT Finance für Tailwind */
        :root {
            --color-skt-blue: #002147;
            --color-skt-blue-light: #043C64;
            --color-skt-grey-light: #f5f5f5;
            --color-skt-grey-medium: #c7c7c7;
            --color-skt-blue-main: #38bdf8;
            --color-accent-green: #27ae60;
            --color-accent-red: #FF6347;
            --color-accent-yellow: #f1c40f;
        }

        .bg-skt-blue { background-color: var(--color-skt-blue); }
        .bg-skt-blue-light { background-color: var(--color-skt-blue-light); }
        .bg-skt-grey-light { background-color: var(--color-skt-grey-light); }
        .bg-skt-grey-medium { background-color: var(--color-skt-grey-medium); }
        .text-skt-blue { color: var(--color-skt-blue); }
        .text-skt-blue-light { color: var(--color-skt-blue-light); }
        .text-skt-blue-main { color: var(--color-skt-blue-main); }
        .border-skt-blue-main { border-color: var(--color-skt-blue-main); }

        /* Neue Akzentfarben */
        .text-skt-green-accent { color: var(--color-accent-green); }
        .bg-skt-green-accent { background-color: var(--color-accent-green); }
        .text-skt-red-accent { color: var(--color-accent-red); }
        .bg-skt-red-accent { background-color: var(--color-accent-red); }
        .text-skt-yellow-accent { color: var(--color-accent-yellow); }
        .bg-skt-yellow-accent { background-color: var(--color-accent-yellow); }
        
        /* Setzen der Schriftart für das gesamte Dashboard auf eine serifenlose Schriftart, wie in der Liste angegeben */
        body {
            font-family: sans-serif;
            background-color: var(--color-skt-grey-light);
        }

        /* Spezieller Stil für die Überschrift mit Times New Roman */
        .font-times-new-roman {
            font-family: "Times New Roman", Times, serif;
        }
        
        /* Stile für den Fortschrittskreis */
        .progress-circle {
            transform: rotate(-90deg);
        }
        .progress-circle .bg-circle {
            fill: none;
            stroke: var(--color-skt-grey-medium);
            stroke-width: 10;
        }
        .progress-circle .progress-arc {
            fill: none;
            stroke: var(--color-accent-green);
            stroke-width: 10;
            transition: stroke-dashoffset 0.7s ease-out;
            stroke-linecap: round;
        }

        /* Neue, dezentere Stile für das Monatsplanungs-Kreisdiagramm */
        .progress-circle-monthly {
            transform: rotate(-90deg);
        }
        .progress-circle-monthly .bg-circle {
            fill: none;
            stroke: #e2e8f0;
            stroke-width: 8; /* Dezenter */
        }
        .progress-circle-monthly .progress-arc-eh {
            fill: none;
            stroke: var(--color-accent-green);
            stroke-width: 10; /* Etwas breiter für EH */
            transition: stroke-dashoffset 0.7s ease-out;
            stroke-linecap: round;
        }
        .progress-circle-monthly .progress-arc-et {
            fill: none;
            stroke: var(--color-skt-blue-main);
            stroke-width: 7; /* Etwas dünner für ET */
            transition: stroke-dashoffset 0.7s ease-out;
            stroke-linecap: round;
        }

        /* Stile für die Karrierestufen-Karten */
        .tier-card {
            background-color: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 2px solid transparent; /* Standard-Transparenter Rand */
        }
        .tier-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        /* Aktive Stufe wird jetzt mit dem grünen Akzent umrandet */
        .tier-card.active {
            border: 2px solid var(--color-accent-green);
        }
        
        /* Stile für Mitarbeiter-Slots */
        .employee-slot {
            width: 20px;
            height: 20px;
            background-color: var(--color-skt-grey-medium);
            border-radius: 50%;
            transition: background-color 0.3s ease-out;
            border: 1px solid var(--color-skt-grey-medium);
        }
        .employee-slot.filled {
            background-color: var(--color-accent-green);
        }
        
        /* Stile für das Dropdown-Menü */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 50;
            width: 200px;
            margin-top: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        .user-list li {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        .user-list li:hover {
            background-color: #f5f5f5;
        }
        .user-list li:last-child {
            border-bottom: none;
        }
        
        .progress-bar-container {
            width: 100%;
            background-color: var(--color-skt-grey-medium);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.7s ease-out;
            border-radius: 4px;
        }
        
        /* Neuer Stil für die vertikalen Linien zwischen den Wochen */
        .week-divider {
            position: absolute;
            height: calc(100% + 0.25rem); /* Kürzere Linie, jetzt halb so lang */
            top: -0.125rem;
            width: 2px;
            background-color: #e2e8f0; /* Dezente graue Linie */
            z-index: 10;
        }
        
        /* Stil für die vertikalen Linien am Anfang und Ende des Balkens (jetzt wie die Wochen-Trenner) */
        .start-end-divider {
            position: absolute;
            height: calc(100% + 0.25rem); /* Kürzere Linie, jetzt halb so lang */
            top: -0.125rem;
            width: 2px;
            background-color: #e2e8f0;
            z-index: 10;
        }
        
        /* Stil für das zentrierte Datums-Label mit größerem Abstand */
        .centered-date-label {
            position: absolute;
            bottom: -1.25rem; /* Größerer Abstand */
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-skt-blue-light);
            white-space: nowrap;
            z-index: 30;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-skt-blue">
    <!-- Neuer Auswahlbereich für Benutzer -->
    <div id="user-select-screen" class="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-xl border border-gray-200 text-center transform transition-transform duration-300 hover:scale-105">
    
            <div class="mb-6">
                <h1 class="text-3xl font-extrabold text-skt-blue leading-tight">Willkommen zurück!</h1>
                <p class="text-gray-500 mt-2">Wähle deinen Namen, um fortzufahren.</p>
            </div>

            <div class="mb-6">
                <div class="relative">
                    <select id="user-dropdown-select" class="block w-full px-4 py-3 rounded-xl border-2 border-gray-300 bg-white text-lg text-gray-700 appearance-none transition-colors duration-200 focus:border-skt-blue-main focus:ring-2 focus:ring-skt-blue-main focus:outline-none pr-10 cursor-pointer">
                        <option value="">Benutzer wählen ...</option>
                        <!-- Benutzer werden hier dynamisch eingefügt -->
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
            </div>
    
            <button id="start-dashboard-btn" class="w-full bg-skt-blue text-white font-semibold py-3 rounded-xl hover:bg-skt-blue-light transition-colors duration-200 shadow-md transform hover:-translate-y-0.5 active:translate-y-0 text-lg">
                Dashboard laden
            </button>
    
            <p id="user-select-error" class="text-red-600 mt-4 h-5 text-sm"></p>
        </div>
    </div>

    <!-- Dashboard-Container, initial ausgeblendet -->
    <div id="dashboard-content" class="hidden flex-col min-h-screen">
        <!-- Begrüßungs-Banner -->
        <header class="w-full p-8 md:p-12 bg-skt-blue relative rounded-b-3xl">
            <div class="max-w-7xl mx-auto flex flex-col sm:flex-row items-start sm:items-center justify-between relative">
                <div class="flex flex-col">
                    <h1 class="text-4xl sm:text-5xl font-bold font-times-new-roman text-white mb-2" id="welcome-header">Willkommen,</h1>
                    <p class="text-lg sm:text-xl text-skt-blue-main">Dein persönliches Dashboard für Erfolg und Karriereplanung.</p>
                </div>
                <!-- Container für den Benutzer-Button und das Dropdown-Menü -->
                <div class="relative mt-4 sm:mt-0">
                    <!-- Neuer Benutzer-Button -->
                    <button id="user-select-button" class="bg-skt-blue-light text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-skt-blue-main transition-colors">
                        Benutzer
                    </button>
                    <!-- Dropdown-Menü -->
                    <div id="user-dropdown" class="dropdown-menu hidden">
                        <ul id="user-list" class="user-list">
                            <!-- Benutzer werden hier dynamisch eingefügt -->
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <!-- Hauptbereich mit Karrieredaten und Zielen -->
        <main class="flex flex-col w-full max-w-7xl mx-auto flex-grow p-6 md:p-8 space-y-12">
            
            <!-- Status- und Ladeanzeige -->
            <div id="status-message" class="text-center text-lg font-semibold text-skt-blue mt-6">Daten werden geladen...</div>

            <!-- Sektion: Monatsplanung - NEUES DESIGN -->
            <section class="bg-white rounded-2xl p-6 md:p-8 shadow-lg">
                <h2 class="text-2xl font-semibold text-skt-blue mb-6 text-center">Deine Monatsplanung</h2>
                
                <!-- Sektion: Monatsfortschritt -->
                <div class="mb-8">
                    <!-- Container für die neue Wochen-Visualisierung -->
                    <div id="weekly-progress-container" class="w-full flex relative h-5 mb-4 items-end">
                        <!-- Inhalt wird dynamisch über JavaScript eingefügt -->
                    </div>
                </div>

                <!-- Sektion: Monatsziel-Fortschritt (Kreisdiagramme & Daten) -->
                <div class="flex flex-col md:flex-row items-center justify-between gap-8 mb-8">
                    <!-- Kombiniertes Kreisdiagramm (links) -->
                    <div class="flex-grow md:w-1/2 relative w-full h-auto max-w-sm max-h-sm">
                        <svg class="progress-circle-monthly w-full h-full" viewBox="0 0 100 100">
                            <!-- Hintergrund-Kreis für Einheiten (größerer Kreis) -->
                            <circle class="bg-circle" cx="50" cy="50" r="40"></circle>
                            <!-- Hintergrund-Kreis für ETs (kleinerer Kreis) -->
                            <circle class="bg-circle" cx="50" cy="50" r="30"></circle>

                            <!-- Fortschritts-Kreis für Einheiten -->
                            <circle class="progress-arc-eh" cx="50" cy="50" r="40" id="progress-circle-eh"></circle>
                            <!-- Fortschritts-Kreis für ETs -->
                            <circle class="progress-arc-et" cx="50" cy="50" r="30" id="progress-circle-et"></circle>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center flex-col text-center">
                            <p class="text-3xl font-bold text-skt-green-accent" id="eh-percentage-text">0%</p>
                            <p class="text-sm text-gray-500">Einheiten</p>
                            <div class="mt-4">
                                <p class="text-xl font-bold text-skt-blue-main" id="et-percentage-text">0%</p>
                                <p class="text-xs text-gray-500">Termine</p>
                            </div>
                        </div>
                    </div>
        
                    <!-- Datenkarten (rechts) -->
                    
                    <div class="flex-grow md:w-1/2 flex flex-col gap-8 w-full">
                        <!-- Datenkarten -->
                        <!-- Anpassen des Rasters, um die verbleibenden Elemente zu zentrieren und gleichmäßig zu verteilen -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-skt-grey-light rounded-xl shadow-md text-center">
                                <p class="text-xs text-skt-blue-light font-bold">Einheiten</p>
                                <p class="text-xl font-bold text-skt-blue mt-1"><span id="eh-current">0</span>/<span id="eh-goal">0</span></p>
                                <p class="text-xs text-gray-500 mt-1">Einheiten hast du schon erreicht.</p>
                            </div>
                            <div class="p-4 bg-skt-grey-light rounded-xl shadow-md text-center">
                                <p class="text-xs text-skt-blue-light font-bold">Termine</p>
                                <p class="text-xl font-bold text-skt-blue mt-1"><span id="at-ver-display">0</span>/<span id="at-soll-display">0</span></p>
                                <p class="text-xs text-gray-500 mt-1">Analysen hast du schon gemacht.</p>
                            </div>
                        </div>
                        <!-- Bewerbungsgesprächs-Visualisierung -->
                        <div class="p-4 bg-skt-grey-light rounded-xl shadow-md">
                            <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4">
                                <p class="text-sm text-skt-blue-light font-bold">Bewerbungsgespräche</p>
                                <p class="text-xl font-bold text-skt-blue mt-2 sm:mt-0"><span id="et-current">0</span>/<span id="et-goal">0</span></p>
                            </div>
                            <div id="interview-pills" class="flex flex-wrap gap-2 items-center">
                                <!-- Pillen werden per JS eingefügt -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>


            <!-- Sektion: Aktueller Fortschritt -->
            <section class="bg-white rounded-2xl p-6 md:p-8 shadow-lg">
                <h2 class="text-2xl font-semibold text-skt-blue mb-6 text-center">Dein aktueller Fortschritt</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- T1-Karte -->
                    <div id="tier-1-card" class="tier-card active">
                        <h3 class="text-2xl font-bold mb-2 text-skt-blue">T1</h3>
                        <p class="text-sm text-skt-blue-light mb-4">0 EH</p>
                        <div class="w-full bg-skt-grey-light h-2 rounded-full overflow-hidden">
                            <div id="tier-1-progress" class="h-full bg-skt-green-accent transition-all duration-700 ease-out" style="width: 100%;"></div>
                        </div>
                    </div>
                    <!-- T2-Karte -->
                    <div id="tier-2-card" class="tier-card">
                        <h3 class="text-2xl font-bold mb-2 text-skt-blue">T2</h3>
                        <p class="text-sm text-skt-blue-light mb-4">1.250 EH</p>
                        <div class="w-full bg-skt-grey-light h-2 rounded-full overflow-hidden">
                            <div id="tier-2-progress" class="h-full bg-skt-green-accent transition-all duration-700 ease-out" style="width: 0%;"></div>
                        </div>
                    </div>
                    <!-- T3-Karte -->
                    <div id="tier-3-card" class="tier-card">
                        <h3 class="text-2xl font-bold mb-2 text-skt-blue">T3</h3>
                        <p class="text-sm text-skt-blue-light mb-4">2.500 EH</p>
                        <div class="w-full bg-skt-grey-light h-2 rounded-full overflow-hidden">
                            <div id="tier-3-progress" class="h-full bg-skt-green-accent transition-all duration-700 ease-out" style="width: 0%;"></div>
                        </div>
                    </div>
                    <!-- Junior GST-Karte -->
                    <div id="tier-gst-card" class="tier-card">
                        <h3 class="text-2xl font-bold mb-2 text-skt-blue">Junior GST</h3>
                        <p class="text-sm text-skt-blue-light mb-4">4.000 EH</p>
                        <div class="w-full bg-skt-grey-light h-2 rounded-full overflow-hidden">
                            <div id="tier-gst-progress" class="h-full bg-skt-green-accent transition-all duration-700 ease-out" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row items-center justify-between gap-8">
                    <!-- Kreisdiagramm (links) -->
                    <div class="flex-grow md:w-1/2 relative w-full h-auto max-w-96 max-h-96">
                        <svg class="progress-circle w-full h-full" viewBox="0 0 100 100">
                            <!-- Hintergrund-Kreis -->
                            <circle class="bg-circle" cx="50" cy="50" r="40"></circle>
                            <!-- Fortschritts-Kreis -->
                            <circle class="progress-arc" cx="50" cy="50" r="40" id="progress-circle-career"></circle>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center flex-col text-center">
                            <!-- Der Text wird jetzt dynamisch aktualisiert, um den Fortschritt zur nächsten Stufe anzuzeigen -->
                            <p id="career-progress-percentage" class="text-5xl font-bold text-skt-blue">0%</p>
                            <p class="text-sm text-skt-blue-light mt-1" id="progress-to-next-text">Fortschritt zum ...</p>
                        </div>
                    </div>
        
                    <!-- Detaillierte Infos (rechts) -->
                    <div class="flex-grow md:w-1/2 grid grid-cols-2 gap-4 w-full">
                        <div class="p-4 bg-skt-grey-light rounded-xl shadow-md flex flex-col items-center justify-center text-center">
                            <p class="text-xs text-skt-blue-light font-bold">Erreichte EH (insgesamt)</p>
                            <p class="text-2xl font-bold text-skt-blue mt-1"><span id="current-eh-display">0</span> EH</p>
                        </div>
                        <!-- Angepasste Mitarbeiter-Karte -->
                        <div class="p-4 bg-skt-grey-light rounded-xl shadow-md flex flex-col items-center justify-center text-center">
                            <p class="text-xs text-skt-blue-light font-bold">Mitarbeiter</p>
                            <div id="employee-info-container" class="mt-1 flex flex-col items-center justify-center">
                                <!-- Dynamische Inhalte für Mitarbeiter und Ziel werden hier eingefügt -->
                                <p class="text-2xl font-bold text-skt-blue" id="employee-count-display">0</p>
                                <p id="employee-goal-status" class="text-skt-blue-light text-sm mt-1">...</p>
                            </div>
                            <div id="employee-slots-container" class="flex space-x-2 mt-2">
                                <!-- Dynamische Mitarbeiter-Slots werden hier eingefügt -->
                            </div>
                        </div>
                        <div class="p-4 col-span-2 bg-skt-grey-light rounded-xl shadow-md flex flex-col items-center justify-center text-center">
                            <p id="next-milestone" class="text-skt-blue-light text-sm font-bold">Nächster Meilenstein: <span class="text-skt-blue font-semibold">...</span></p>
                        </div>
                    </div>
                </div>
            </section>      
        </main>
    </div>

    <script>
        // --- KONFIGURATION
        const spreadsheetId = "1n8NQjGpZpkETLFw7JoY96aYFzwR9_V0WtWwBM9MsN7w";
        const sheetDataName = "Daten";
        const sheetPromotionsName = "Anstehende Beförderungen";

        const USER_FILTER_PREFIXES = ["geschäftsstelle", "bezirksleitung", "neuer ma", "wgst", "wbl", "ga", "jgst", "summe direktion", "rd königslehner"];

        const tierGoals = [
            { name: "T1", goal: 1250 },
            { name: "T2", goal: 2500 },
            { name: "T3", goal: 4000 },
            { name: "Junior GST", goal: 4001 }
        ];

        let monthlyTargetEh = 0, monthlyCurrentEh = 0, atSoll = 0, atVer = 0, etSoll = 0, istEt = 0, totalCurrentEh = 0;
        let employeeGoal = null, employeesMissing = null, employeeCount = 0;

        // --- DOM ELEMENTS
        const dom = {
            welcomeHeader: document.getElementById('welcome-header'),
            statusMessage: document.getElementById('status-message'),
            fortschrittKreisKarriere: document.getElementById('progress-circle-career'),
            careerProgressPercentage: document.getElementById('career-progress-percentage'),
            progressToNextText: document.getElementById('progress-to-next-text'),
            currentEhDisplay: document.getElementById('current-eh-display'),
            nextMilestone: document.getElementById('next-milestone'),
            weeklyProgressContainer: document.getElementById('weekly-progress-container'),
            ehProgressCircle: document.getElementById('progress-circle-eh'),
            etProgressCircle: document.getElementById('progress-circle-et'),
            ehPercentageText: document.getElementById('eh-percentage-text'),
            etPercentageText: document.getElementById('et-percentage-text'),
            ehCurrentDisplay: document.getElementById('eh-current'),
            ehGoalDisplay: document.getElementById('eh-goal'),
            etCurrentDisplay: document.getElementById('et-current'),
            etGoalDisplay: document.getElementById('et-goal'),
            atSollDisplay: document.getElementById('at-soll-display'),
            atVerDisplay: document.getElementById('at-ver-display'),
            employeeCountDisplay: document.getElementById('employee-count-display'),
            employeeSlotsContainer: document.getElementById('employee-slots-container'),
            employeeGoalStatus: document.getElementById('employee-goal-status'),
            interviewPillsContainer: document.getElementById('interview-pills'),
            userDropdownSelect: document.getElementById('user-dropdown-select'),
            userSelectError: document.getElementById('user-select-error'),
            tierCards: [
                document.getElementById('tier-1-card'),
                document.getElementById('tier-2-card'),
                document.getElementById('tier-3-card'),
                document.getElementById('tier-gst-card')
            ],
            tierProgressBars: [
                document.getElementById('tier-1-progress'),
                document.getElementById('tier-2-progress'),
                document.getElementById('tier-3-progress'),
                document.getElementById('tier-gst-progress')
            ],
            userSelectButton: document.getElementById('user-select-button'),
            userDropdown: document.getElementById('user-dropdown'),
            userListElement: document.getElementById('user-list')
        };

        // --- HILFSFUNKTIONEN ---
        function setStatus(msg, isError = false) {
            dom.statusMessage.textContent = msg;
            dom.statusMessage.style.color = isError ? 'red' : '';
            dom.statusMessage.style.display = msg ? 'block' : 'none';
        }

        function clearChildren(el) { while(el.firstChild) el.removeChild(el.firstChild); }

        function updateCircleProgress(svgElement, radius, percentage) {
            if (!svgElement) return;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference * (1 - Math.min(percentage, 100) / 100);
            svgElement.style.strokeDasharray = circumference;
            svgElement.style.strokeDashoffset = offset;
        }

        function getFirstWeekdayOfMonth(year, month, weekday) {
            const date = new Date(year, month, 1);
            while (date.getDay() !== weekday) date.setDate(date.getDate() + 1);
            return date;
        }

        function getMonthlyCycleDates() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            let startDate = getFirstWeekdayOfMonth(year, month, 4); // Donnerstag
            let nextMonth = (month + 1) % 12;
            let nextYear = year + Math.floor((month + 1)/12);
            let endDate = getFirstWeekdayOfMonth(nextYear, nextMonth, 3); // Mittwoch
            if (endDate.getDate() === 1) endDate.setDate(endDate.getDate()+7);
            return { startDate, endDate };
        }

        async function fetchSheetQuery(sheet, query) {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&sheet=${sheet}&tq=${encodeURIComponent(query)}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`Network response was not ok: ${res.statusText}`);
                const text = await res.text();
                const jsonString = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                return JSON.parse(jsonString);
            } catch (err) {
                console.error(`Fehler beim Abrufen von ${sheet}:`, err);
                setStatus(`Fehler beim Laden der Daten aus Tabelle "${sheet}".`, true);
                return null;
            }
        }

        function filterUsers(rawUsers) {
            return rawUsers.filter(u => {
                const n = u.toLowerCase().trim();
                return !n.includes('x') && !USER_FILTER_PREFIXES.some(f => n.startsWith(f) || n === f);
            });
        }

        // --- DASHBOARD FUNKTIONEN ---
        function startDashboard(){
            const selectedUser = dom.userDropdownSelect.value;
            if (!selectedUser) {
                dom.userSelectError.textContent = "Bitte zuerst einen Benutzer auswählen.";
                return;
            }
            dom.userSelectError.textContent = "";

            document.getElementById('user-select-screen').classList.add('hidden');
            const dashboardContent = document.getElementById('dashboard-content');
            dashboardContent.classList.remove('hidden');
            dashboardContent.classList.add('flex');

            fetchAndRenderDashboard(selectedUser);
        }

        async function fetchUserData(userName) {
            const query = `select B, C, D, E, F, G, H, I where A = '${userName.trim()}'`;
            const data = await fetchSheetQuery(sheetDataName, query);
            if (data && data.table.rows.length > 0 && data.table.rows[0].c) {
                const row = data.table.rows[0].c;
                monthlyTargetEh = Math.round(row[0]?.v || 0);
                monthlyCurrentEh = Math.round(row[1]?.v || 0);
                etSoll = Math.round(row[2]?.v || 0);
                istEt = Math.round(row[3]?.v || 0);
                atSoll = Math.round(row[4]?.v || 0);
                atVer = Math.round(row[5]?.v || 0);
                totalCurrentEh = Math.round(row[7]?.v || 0);
                employeeCount = 0; // Wird aus Promotionsdaten bestimmt
            } else {
                monthlyTargetEh = monthlyCurrentEh = atSoll = atVer = etSoll = istEt = totalCurrentEh = employeeCount = 0;
                setStatus(`Keine Daten für Benutzer "${userName}" gefunden.`, true);
            }
        }

        async function fetchPromotionData(userName) {
            employeeGoal = 'none';
            employeesMissing = 0;
            const query = `select A, B where A is not null`;
            const data = await fetchSheetQuery(sheetPromotionsName, query);
            if (!data) return;
            let section = null;
            for (const row of data.table.rows) {
                const name = row.c[0]?.v, missing = row.c[1]?.v;
                if (!name) continue;
                if (name.includes('BL Beförderungen')) { section='BL'; continue; }
                if (name.includes('GST Beförderungen')) { section='GST'; continue; }
                if (name.toLowerCase().trim() === userName.toLowerCase().trim() && section) {
                    employeeGoal = section;
                    employeesMissing = missing;
                    break;
                }
            }
        }

        function updateWeeklyProgress() {
            const { startDate, endDate } = getMonthlyCycleDates();
            const today = new Date();
            dom.weeklyProgressContainer.innerHTML = ''; // Container leeren

            const totalDays = (endDate - startDate) / (1000 * 60 * 60 * 24);
            const daysInAWeek = 7;
            const totalWeeks = Math.ceil(totalDays / daysInAWeek);
            const dateOptions = { day: '2-digit', month: '2-digit' };

            // Startlinie links
            const startDivider = document.createElement('div');
            startDivider.classList.add('start-end-divider');
            startDivider.style.left = '0%';
            dom.weeklyProgressContainer.appendChild(startDivider);

            // Startdatum-Label
            const startLabel = document.createElement('div');
            startLabel.classList.add('centered-date-label');
            startLabel.style.left = '0%';
            startLabel.style.transform = 'translateX(-50%)';
            startLabel.textContent = startDate.toLocaleDateString('de-DE', dateOptions);
            dom.weeklyProgressContainer.appendChild(startLabel);

            // Wochenbalken
            for (let i = 0; i < totalWeeks; i++) {
                const weekStart = new Date(startDate.getTime() + i * daysInAWeek * 24 * 60 * 60 * 1000);
                const weekEnd = new Date(weekStart.getTime() + daysInAWeek * 24 * 60 * 60 * 1000);

                let progress = 0;
                if (today >= weekEnd) {
                    progress = 100;
                } else if (today >= weekStart && today < weekEnd) {
                    const daysPassed = (today - weekStart) / (1000 * 60 * 60 * 24);
                    progress = (daysPassed / daysInAWeek) * 100;
                }

                const weekDiv = document.createElement('div');
                weekDiv.classList.add('flex-1', 'h-full', 'relative', 'p-2', 'flex', 'flex-col', 'items-center', 'z-20');

                const barContainer = document.createElement('div');
                barContainer.classList.add('w-full', 'bg-skt-grey-medium', 'h-2', 'rounded-full', 'overflow-hidden');

                const bar = document.createElement('div');
                bar.classList.add('h-full', 'bg-skt-green-accent', 'rounded-full', 'transition-all', 'duration-500');
                bar.style.width = `${Math.min(progress, 100)}%`;

                barContainer.appendChild(bar);
                weekDiv.appendChild(barContainer);
                dom.weeklyProgressContainer.appendChild(weekDiv);
            }

            // Linien & Mittwoche-Labels zwischen Wochen
            const weeksDivs = dom.weeklyProgressContainer.querySelectorAll('.flex-1');
            weeksDivs.forEach((div, i) => {
                if (i === weeksDivs.length - 1) return; // letzte Woche überspringen

                const divider = document.createElement('div');
                divider.classList.add('week-divider');
                divider.style.left = `${(i + 1) * (100 / weeksDivs.length)}%`;
                dom.weeklyProgressContainer.appendChild(divider);

                const wednesday = new Date(startDate.getTime() + i * daysInAWeek * 24 * 60 * 60 * 1000);
                wednesday.setDate(wednesday.getDate() + (3 - wednesday.getDay() + 7) % 7); // Mittwoch

                const label = document.createElement('div');
                label.classList.add('centered-date-label');
                label.style.left = `${(i + 1) * (100 / weeksDivs.length)}%`;
                label.style.transform = 'translateX(-50%)';
                label.textContent = wednesday.toLocaleDateString('de-DE', dateOptions);
                dom.weeklyProgressContainer.appendChild(label);
            });

            // Endlinie rechts
            const endDivider = document.createElement('div');
            endDivider.classList.add('start-end-divider');
            endDivider.style.right = '0%';
            dom.weeklyProgressContainer.appendChild(endDivider);

            const endLabel = document.createElement('div');
            endLabel.classList.add('centered-date-label');
            endLabel.style.right = '0%';
            endLabel.style.transform = 'translateX(50%)';
            endLabel.textContent = endDate.toLocaleDateString('de-DE', dateOptions);
            dom.weeklyProgressContainer.appendChild(endLabel);
        }

        function updateProgress() {
            updateWeeklyProgress();

            dom.ehCurrentDisplay.textContent = monthlyCurrentEh;
            dom.ehGoalDisplay.textContent = monthlyTargetEh;
            dom.etCurrentDisplay.textContent = istEt;
            dom.etGoalDisplay.textContent = etSoll;
            dom.atSollDisplay.textContent = atSoll;
            dom.atVerDisplay.textContent = atVer;
            
            dom.ehPercentageText.textContent = `${Math.min(monthlyTargetEh > 0 ? (monthlyCurrentEh / monthlyTargetEh * 100) : 0, 100).toFixed(1)}%`;
            dom.etPercentageText.textContent = `${Math.min(atSoll > 0 ? (atVer / atSoll * 100) : 0, 100).toFixed(1)}%`;

            updateCircleProgress(dom.ehProgressCircle, 40, monthlyTargetEh > 0 ? (monthlyCurrentEh / monthlyTargetEh * 100) : 0);
            updateCircleProgress(dom.etProgressCircle, 30, atSoll > 0 ? (atVer / atSoll * 100) : 0);
            dom.currentEhDisplay.textContent = totalCurrentEh;

            // Bewerbungspillen
            clearChildren(dom.interviewPillsContainer);
            for(let i=0; i < etSoll; i++){
                const pill = document.createElement('div');
                pill.className = `px-3 py-1 text-white text-xs font-semibold rounded-full shadow-md ${i < istEt ? 'bg-skt-green-accent':'bg-skt-blue-light'}`;
                pill.textContent = i + 1;
                dom.interviewPillsContainer.appendChild(pill);
            }

            // Karrierefortschritt
            let curTier=-1, curGoal=0, nextGoal=0, nextName="";
            if(totalCurrentEh < 1251){ curTier=0; nextGoal=1250; nextName="T2"; }
            else if(totalCurrentEh < 2501){ curTier=1; curGoal=1250; nextGoal=2500; nextName="T3"; }
            else if(totalCurrentEh < 4001){ curTier=2; curGoal=2500; nextGoal=4000; nextName="Junior GST"; }
            else curTier=3;

            dom.tierCards.forEach(c => c.classList.remove('active'));
            dom.tierProgressBars.forEach(b => b.style.width='0%');

            if(curTier === 3){
                dom.tierCards.forEach(c => c.classList.add('active'));
                dom.tierProgressBars.forEach(b => b.style.width='100%');
                dom.careerProgressPercentage.textContent="100%";
                dom.progressToNextText.textContent="Junior GST erreicht!";
                dom.nextMilestone.innerHTML='Nächster Meilenstein: <span class="text-skt-blue font-semibold">Erfolgreich!</span>';
                updateCircleProgress(dom.fortschrittKreisKarriere, 40, 100);
            } else {
                const spanCur = totalCurrentEh - curGoal, spanNext = nextGoal - curGoal;
                const percent = spanNext > 0 ? (spanCur / spanNext * 100) : 0;
                dom.careerProgressPercentage.textContent=`${Math.min(percent, 100).toFixed(1)}%`;
                dom.progressToNextText.textContent=`Fortschritt zum ${nextName}`;
                dom.nextMilestone.innerHTML=`Nächster Meilenstein: <span class="text-skt-blue font-semibold">${nextName} (${nextGoal} EH)</span>`;
                updateCircleProgress(dom.fortschrittKreisKarriere, 40, percent);

                // Progress Bars
                if (dom.tierProgressBars[0]) dom.tierProgressBars[0].style.width=`${Math.min(totalCurrentEh / tierGoals[0].goal * 100, 100)}%`; 
                if (totalCurrentEh >= tierGoals[0].goal && dom.tierCards[0]) dom.tierCards[0].classList.add('active');
                
                if (dom.tierProgressBars[1]) dom.tierProgressBars[1].style.width=`${Math.min(Math.max(0, totalCurrentEh - tierGoals[0].goal) / (tierGoals[1].goal - tierGoals[0].goal) * 100, 100)}%`; 
                if (totalCurrentEh >= tierGoals[1].goal && dom.tierCards[1]) dom.tierCards[1].classList.add('active');

                if (dom.tierProgressBars[2]) dom.tierProgressBars[2].style.width=`${Math.min(Math.max(0, totalCurrentEh - tierGoals[1].goal) / (tierGoals[2].goal - tierGoals[1].goal) * 100, 100)}%`; 
                if (totalCurrentEh >= tierGoals[2].goal && dom.tierCards[2]) dom.tierCards[2].classList.add('active');
                
                if (dom.tierCards[curTier]) dom.tierCards[curTier].classList.add('active');
            }

            // Mitarbeiter Slots
            clearChildren(dom.employeeSlotsContainer);
            dom.employeeGoalStatus.classList.remove('text-skt-red-accent','text-skt-blue-light','font-semibold');

            if(employeeGoal === 'none'){
                dom.employeeCountDisplay.textContent = employeeCount;
                dom.employeeGoalStatus.textContent = 'Karriereschritt besprechen';
                dom.employeeGoalStatus.classList.add('text-skt-red-accent','font-semibold');
            } else {
                const required = employeeGoal === 'BL' ? 6 : 3;
                const filled = required - employeesMissing;
                dom.employeeCountDisplay.textContent = `${filled} / ${required} MA`;
                dom.employeeGoalStatus.textContent = `Ziel: ${employeeGoal}`;
                dom.employeeGoalStatus.classList.add('text-skt-blue-light');
                for(let i=0; i < required; i++){
                    const slot=document.createElement('div'); slot.classList.add('employee-slot'); if(i < filled) slot.classList.add('filled');
                    dom.employeeSlotsContainer.appendChild(slot);
                }
            }
        }

        async function fetchAndRenderDashboard(userName){
            setStatus('Daten werden geladen...');
            dom.welcomeHeader.textContent=`Willkommen, ${userName}`;
            await Promise.all([fetchUserData(userName), fetchPromotionData(userName)]);
            setStatus('');
            updateProgress();
        }

        async function populateUserDropdown(){
            const data = await fetchSheetQuery(sheetDataName, 'select A');
            if(!data || !data.table.rows){ dom.userDropdownSelect.innerHTML='<option value="">Fehler</option>'; return; }
            const users = filterUsers(data.table.rows.map(r=>r.c[0]?.v).filter(Boolean));
            users.forEach(u=>{
                const opt = document.createElement('option'); opt.value=opt.textContent=u; dom.userDropdownSelect.appendChild(opt);
            });
        }

        async function fetchUserList(){
            const data = await fetchSheetQuery(sheetDataName, 'select A');
            if(!data || !data.table.rows){ dom.userListElement.innerHTML='<li class="text-skt-red-accent">Fehler</li>'; return; }
            const users = filterUsers(data.table.rows.map(r=>r.c[0]?.v).filter(Boolean));
            clearChildren(dom.userListElement);
            users.forEach(u=>{
                const li = document.createElement('li'); li.textContent=u;
                li.className='py-3 px-4 rounded-md hover:bg-skt-grey-light cursor-pointer transition-colors text-skt-blue-light';
                li.addEventListener('click',()=>{fetchAndRenderDashboard(u); dom.userDropdown.classList.add('hidden');});
                dom.userListElement.appendChild(li);
            });
        }

        // --- EVENTS ---
        dom.userSelectButton.addEventListener('click', ()=>{ fetchUserList(); dom.userDropdown.classList.toggle('hidden'); });
        window.addEventListener('click', e=>{ if(!dom.userSelectButton.contains(e.target) && !dom.userDropdown.contains(e.target)) dom.userDropdown.classList.add('hidden'); });

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            populateUserDropdown();
            const startButton = document.getElementById('start-dashboard-btn');
            if (startButton) {
                startButton.addEventListener('click', startDashboard);
            } else {
                console.error("Start button not found!");
            }
        });

    </script>
</body>
</html>